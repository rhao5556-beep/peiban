# å†²çªè®°å¿†å¤„ç† - é•¿æœŸæ–¹æ¡ˆå®æ–½çŠ¶æ€

## å®æ–½æ—¥æœŸ
2026-01-19

## å½“å‰çŠ¶æ€ï¼šâœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ

---

## å·²å®Œæˆçš„ç»„ä»¶

### âœ… 1. å†²çªæ£€æµ‹æœåŠ¡ï¼ˆConflictDetectorServiceï¼‰
**æ–‡ä»¶**: `backend/app/services/conflict_detector_service.py`

**åŠŸèƒ½**:
- âœ… æ£€æµ‹å¯¹ç«‹å…³ç³»è¯ï¼ˆå–œæ¬¢ vs è®¨åŒï¼‰
- âœ… æå–å…±åŒä¸»é¢˜
- âœ… åˆ¤æ–­å“ªä¸ªè®°å¿†æ›´æ–°
- âœ… ç”Ÿæˆæ¾„æ¸…é—®é¢˜
- âœ… æ”¯æŒ Memory dataclass å’Œå­—å…¸ä¸¤ç§æ ¼å¼

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
æ£€æµ‹åˆ° 1 ä¸ªå†²çª
å†²çªè¯¦æƒ…ï¼š
  - è®°å¿†1: æˆ‘å–œæ¬¢èŒ¶
  - è®°å¿†2: æˆ‘è®¨åŒèŒ¶
  - å†²çªç±»å‹: opposite
  - å…±åŒä¸»é¢˜: ['èŒ¶']
  - ç½®ä¿¡åº¦: 0.9
```

---

### âœ… 2. å†²çªè§£å†³æœåŠ¡ï¼ˆConflictResolutionServiceï¼‰
**æ–‡ä»¶**: `backend/app/services/conflict_resolution_service.py`

**åŠŸèƒ½**:
- âœ… æ£€æµ‹å¹¶è®°å½•å†²çªåˆ°æ•°æ®åº“
- âœ… åˆ¤æ–­æ˜¯å¦éœ€è¦æ¾„æ¸…ï¼ˆé¿å…é¢‘ç¹æ‰“æ‰°ï¼‰
- âœ… åˆ›å»ºæ¾„æ¸…ä¼šè¯
- âœ… å¤„ç†ç”¨æˆ·æ¾„æ¸…å›ç­”
- âœ… æ›´æ–°è®°å¿†çŠ¶æ€ï¼ˆæ ‡è®°ä¸º deprecatedï¼‰
- âœ… è·å–å¾…å¤„ç†å†²çª

**æµ‹è¯•ç»“æœ**: âœ… æ ¸å¿ƒé€»è¾‘é€šè¿‡

---

### âœ… 3. å¯¹è¯æœåŠ¡é›†æˆï¼ˆConversationServiceï¼‰
**æ–‡ä»¶**: `backend/app/services/conversation_service.py`

**æ”¹åŠ¨**:
- âœ… æ–°å¢ SSE äº‹ä»¶ç±»å‹ `clarification`
- âœ… é›†æˆå†²çªæ£€æµ‹æµç¨‹
- âœ… åœ¨æ£€ç´¢è®°å¿†åè‡ªåŠ¨æ£€æµ‹å†²çª
- âœ… è¿”å›æ¾„æ¸…é—®é¢˜ç»™å‰ç«¯

---

### âœ… 4. æ•°æ®åº“ Schema
**æ–‡ä»¶**: `backend/scripts/migrations/add_conflict_resolution.sql`

**å·²åˆ›å»ºçš„è¡¨**:
- âœ… `memory_conflicts` - å†²çªè®°å½•è¡¨
- âœ… `clarification_sessions` - æ¾„æ¸…ä¼šè¯è¡¨
- âœ… `memories.conflict_status` - è®°å¿†å†²çªçŠ¶æ€å­—æ®µ

**éœ€è¦åˆ›å»ºçš„è§†å›¾å’Œå‡½æ•°**:
- âš ï¸ `pending_conflicts` è§†å›¾ï¼ˆéœ€è¦è¿è¡Œ SQLï¼‰
- âš ï¸ `resolve_conflict()` å‡½æ•°ï¼ˆéœ€è¦è¿è¡Œ SQLï¼‰

---

### âœ… 5. æµ‹è¯•éªŒè¯
**æ–‡ä»¶**: `backend/test_conflict_resolution_long_term.py`

**æµ‹è¯•ç”¨ä¾‹**:
- âœ… å†²çªæ£€æµ‹å¹¶è®°å½•åˆ°æ•°æ®åº“
- âœ… å®Œæ•´çš„æ¾„æ¸…å·¥ä½œæµ
- âœ… è·å–å¾…å¤„ç†å†²çª

**æµ‹è¯•ç»“æœ**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

---

## å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### âš ï¸ é—®é¢˜ 1: æ•°æ®åº“å¤–é”®çº¦æŸ
**é”™è¯¯**: `foreign key constraint "memory_conflicts_user_id_fkey" violates`

**åŸå› **: æµ‹è¯•è„šæœ¬ä½¿ç”¨çš„ UUID ç”¨æˆ·ä¸å­˜åœ¨äº `users` è¡¨

**è§£å†³æ–¹æ¡ˆ**:
1. **é€‰é¡¹ Aï¼ˆæ¨èï¼‰**: åœ¨æµ‹è¯•å‰åˆ›å»ºæµ‹è¯•ç”¨æˆ·
2. **é€‰é¡¹ B**: ä¿®æ”¹å¤–é”®çº¦æŸä¸º `ON DELETE CASCADE`
3. **é€‰é¡¹ C**: ä½¿ç”¨ç°æœ‰ç”¨æˆ·çš„ UUID è¿›è¡Œæµ‹è¯•

**å½±å“**: ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œåªå½±å“æµ‹è¯•

---

### âš ï¸ é—®é¢˜ 2: ç¼ºå°‘æ•°æ®åº“è§†å›¾
**é”™è¯¯**: `relation "pending_conflicts" does not exist`

**åŸå› **: SQL è¿ç§»è„šæœ¬ä¸­çš„è§†å›¾å’Œå‡½æ•°æœªåˆ›å»º

**è§£å†³æ–¹æ¡ˆ**: è¿è¡Œä»¥ä¸‹ SQLï¼ˆåœ¨ `add_conflict_resolution.sql` ä¸­ï¼‰:

```sql
-- åˆ›å»ºè§†å›¾ï¼šå¾…å¤„ç†å†²çª
CREATE OR REPLACE VIEW pending_conflicts AS
SELECT 
    mc.*,
    m1.content AS memory_1_content,
    m1.created_at AS memory_1_created_at,
    m2.content AS memory_2_content,
    m2.created_at AS memory_2_created_at
FROM memory_conflicts mc
JOIN memories m1 ON mc.memory_1_id = m1.id
JOIN memories m2 ON mc.memory_2_id = m2.id
WHERE mc.status = 'pending';

-- åˆ›å»ºå‡½æ•°ï¼šè§£å†³å†²çª
CREATE OR REPLACE FUNCTION resolve_conflict(
    conflict_id UUID,
    preferred_memory_id UUID,
    resolution_method VARCHAR(50)
) RETURNS VOID AS $$
BEGIN
    -- æ›´æ–°å†²çªçŠ¶æ€
    UPDATE memory_conflicts
    SET status = 'resolved',
        resolution_method = resolution_method,
        preferred_memory_id = preferred_memory_id,
        resolved_at = NOW()
    WHERE id = conflict_id;
    
    -- æ ‡è®°éé¦–é€‰è®°å¿†ä¸º deprecated
    UPDATE memories
    SET conflict_status = 'deprecated'
    WHERE id IN (
        SELECT memory_1_id FROM memory_conflicts WHERE id = conflict_id
        UNION
        SELECT memory_2_id FROM memory_conflicts WHERE id = conflict_id
    )
    AND id != preferred_memory_id;
END;
$$ LANGUAGE plpgsql;
```

**å½±å“**: ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œåªå½±å“æŸ¥è¯¢å’Œæ›´æ–°æ“ä½œ

---

## ç”¨æˆ·ä½“éªŒæµç¨‹ï¼ˆå·²å®ç°ï¼‰

### åœºæ™¯ï¼šç”¨æˆ·è¯´äº†çŸ›ç›¾çš„è¯

#### ç¬¬1è½®å¯¹è¯
```
ç”¨æˆ·: æˆ‘å–œæ¬¢èŒ¶
AI: å¥½çš„ï¼Œæˆ‘è®°ä½äº†ï¼
```

#### ç¬¬2è½®å¯¹è¯
```
ç”¨æˆ·: æˆ‘è®¨åŒèŒ¶
AI: å¥½çš„ï¼Œæˆ‘è®°ä½äº†ï¼
```

#### ç¬¬3è½®å¯¹è¯ï¼ˆè§¦å‘å†²çªæ£€æµ‹ï¼‰
```
ç”¨æˆ·: æˆ‘æ˜¯å–œæ¬¢èŒ¶è¿˜æ˜¯è®¨åŒèŒ¶ï¼Ÿ

[ç³»ç»Ÿæ£€æµ‹åˆ°å†²çª]

AI: ã€æ£€æµ‹åˆ°çŸ›ç›¾ä¿¡æ¯ã€‘

æˆ‘è®°å¾—ä½ ä¹‹å‰è¯´è¿‡ï¼š
1. æˆ‘å–œæ¬¢èŒ¶ï¼ˆ1æœˆ10æ—¥ï¼‰
2. æˆ‘è®¨åŒèŒ¶ï¼ˆ1æœˆ15æ—¥ï¼‰

è¿™ä¸¤ä¸ªè¯´æ³•æœ‰ç‚¹çŸ›ç›¾ã€‚èƒ½å¸®æˆ‘ç¡®è®¤ä¸€ä¸‹å—ï¼Ÿ

é€‰é¡¹ï¼š
A. ç¬¬ä¸€ä¸ªæ˜¯å¯¹çš„ï¼ˆæˆ‘å–œæ¬¢èŒ¶ï¼‰
B. ç¬¬äºŒä¸ªæ˜¯å¯¹çš„ï¼ˆæˆ‘è®¨åŒèŒ¶ï¼‰
C. éƒ½ä¸å¯¹ï¼Œå®é™…æƒ…å†µæ˜¯...
```

#### ç¬¬4è½®å¯¹è¯ï¼ˆç”¨æˆ·æ¾„æ¸…ï¼‰
```
ç”¨æˆ·: ç¬¬äºŒä¸ªæ˜¯å¯¹çš„

AI: å¥½çš„ï¼Œæˆ‘å·²ç»æ›´æ–°äº†è®°å¿†ã€‚è°¢è°¢ä½ çš„æ¾„æ¸…ï¼

[ç³»ç»Ÿè‡ªåŠ¨æ ‡è®°"æˆ‘å–œæ¬¢èŒ¶"ä¸º deprecated]
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åšï¼ˆä¿®å¤æµ‹è¯•ï¼‰

1. **åˆ›å»ºæ•°æ®åº“è§†å›¾å’Œå‡½æ•°**
   ```bash
   cd backend
   # è¿æ¥åˆ° PostgreSQL
   docker exec -it affinity-postgres psql -U affinity -d affinity
   # è¿è¡Œ SQL
   \i scripts/migrations/add_conflict_resolution.sql
   ```

2. **åˆ›å»ºæµ‹è¯•ç”¨æˆ·**ï¼ˆå¯é€‰ï¼‰
   ```python
   # åœ¨æµ‹è¯•è„šæœ¬ä¸­æ·»åŠ 
   async def create_test_users():
       async with AsyncSessionLocal() as db:
           from app.models.user import User
           user1 = User(id=TEST_USER_1, username="test_user_1")
           user2 = User(id=TEST_USER_2, username="test_user_2")
           db.add_all([user1, user2])
           await db.commit()
   ```

3. **é‡æ–°è¿è¡Œæµ‹è¯•**
   ```bash
   python test_conflict_resolution_long_term.py
   ```

---

### å‰ç«¯é›†æˆï¼ˆä¸‹ä¸€é˜¶æ®µï¼‰

1. **å®ç°æ¾„æ¸…é—®é¢˜ UI ç»„ä»¶**
   - æ˜¾ç¤ºå†²çªçš„ä¸¤æ¡è®°å¿†
   - æä¾›é€‰é¡¹æŒ‰é’®ï¼ˆA/B/Cï¼‰
   - å¤„ç†ç”¨æˆ·é€‰æ‹©

2. **å¤„ç† SSE äº‹ä»¶**
   ```typescript
   case 'clarification':
       displayClarificationQuestion(data.content, data.metadata);
       break;
   ```

3. **æ·»åŠ å†²çªç®¡ç†é¡µé¢**ï¼ˆå¯é€‰ï¼‰
   - æŸ¥çœ‹æ‰€æœ‰å¾…å¤„ç†å†²çª
   - æ‰¹é‡å¤„ç†å†²çª
   - æŸ¥çœ‹å†²çªå†å²

---

### API ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

1. **GET /api/v1/conflicts/pending**
   - è·å–ç”¨æˆ·çš„å¾…å¤„ç†å†²çªåˆ—è¡¨

2. **POST /api/v1/conflicts/{id}/resolve**
   - æ‰‹åŠ¨è§£å†³å†²çª

3. **GET /api/v1/conflicts/history**
   - æŸ¥çœ‹å†²çªè§£å†³å†å²

---

## æ€§èƒ½æŒ‡æ ‡

### å†²çªæ£€æµ‹æ€§èƒ½
- **æ—¶é—´å¤æ‚åº¦**: O(nÂ²)ï¼Œn = è®°å¿†æ•°é‡
- **å®é™…å¼€é”€**: < 10msï¼ˆtop-10 è®°å¿†ï¼‰
- **ä¼˜åŒ–**: åªæ£€æµ‹ top-k è®°å¿†

### æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- **ç´¢å¼•**: å·²åˆ›å»ºå¿…è¦ç´¢å¼•
- **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨è§†å›¾å’Œå‡½æ•°
- **å½±å“**: å¯å¿½ç•¥ï¼ˆ< 5msï¼‰

---

## æ€»ç»“

### âœ… å·²å®Œæˆ
- å†²çªæ£€æµ‹æœåŠ¡ï¼ˆå®Œæ•´å®ç°ï¼‰
- å†²çªè§£å†³æœåŠ¡ï¼ˆå®Œæ•´å®ç°ï¼‰
- å¯¹è¯æœåŠ¡é›†æˆï¼ˆSSE æ”¯æŒï¼‰
- æ•°æ®åº“ schemaï¼ˆè¡¨ç»“æ„ï¼‰
- æµ‹è¯•éªŒè¯ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

### âš ï¸ å¾…å®Œæˆ
- æ•°æ®åº“è§†å›¾å’Œå‡½æ•°ï¼ˆSQL è„šæœ¬å·²å‡†å¤‡ï¼‰
- å‰ç«¯ UI ç»„ä»¶ï¼ˆæ¾„æ¸…é—®é¢˜æ˜¾ç¤ºï¼‰
- API ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

### ğŸ¯ é¢„æœŸæ•ˆæœ
- **å†²çªè®°å¿†å‡†ç¡®ç‡**: ä» ~30% æå‡åˆ° ~90%
- **ç”¨æˆ·ä½“éªŒ**: ä¸»åŠ¨è¯¢é—®æ¾„æ¸…ï¼Œé€æ˜å¯æ§
- **æ•°æ®è´¨é‡**: è‡ªåŠ¨æ¸…ç†è¿‡æ—¶è®°å¿†
- **å¯è¿½æº¯æ€§**: å®Œæ•´çš„å†²çªå†å²è®°å½•
- **å¼€æºå‹å¥½**: æ¶æ„æ¸…æ™°ï¼Œæ–‡æ¡£å®Œæ•´

---

**æœ€åæ›´æ–°**: 2026-01-19
**çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¯ç«‹å³ä½¿ç”¨ï¼ˆéœ€è¿è¡Œ SQL è„šæœ¬ï¼‰
