# 好感度系统 V2 设计文档

## 1. 核心设计原则

### 1.1 三大原则

1. **不要过度惩罚模糊信号**
   - 频率下降、回复变短 → 可能是用户忙，先观察
   - 只有多个负面信号叠加时，才大幅扣分

2. **高度重视"行为成本"信号**
   - 行为成本 = 用户为这个行为付出的心理门槛
   - 发文字（低）< 发语音（中）< 发照片（高）< 分享私密困扰（极高）
   - 成本越高 → 权重越大

3. **伦理红线必须有"熔断机制"**
   - 删除所有记忆、自杀倾向、过度依赖 → 不只是扣分，要人工介入
   - 产品设计要有"安全气囊"

### 1.2 产品目标

```
❌ 错误目标：让用户每天使用8小时（留存最大化）
✅ 正确目标：让用户在需要时得到陪伴，不需要时回归生活（健康陪伴）
```

---

## 2. 信号来源与权重

### 2.1 来源1：文本内容

| 信号类型 | 示例 | 情感标签 | 权重 | 备注 |
|---------|------|---------|------|------|
| 情绪词 | "我今天超开心！🎉" | 喜悦 +8 | 0.9 | 强情绪词 |
| 省略号+回避 | "...算了，不说了" | 失落 -3, 距离 -2 | 0.7 | 需要关心 |
| 深层自我暴露 | "我昨天失恋了" | 信任 +10 | 1.0 | 关键信号 |
| 依恋性问题 | "你会忘记我吗？" | 不安全感 +5 | 0.9 | 需要安抚 |

### 2.2 来源2：行为数据

| 信号类型 | 示例 | 情感标签 | 权重 | 备注 |
|---------|------|---------|------|------|
| 时间模式 | 连续3天晚上11点后发起对话 | 孤独 +3 | 0.6 | 长期观察 |
| 高频互动 | 连续7天每天主动发起对话 | 依赖 +6 | 0.8 | 注意衰减 |
| 忽略行为 | 3天未回复AI的主动消息 | 距离 -4 | 0.5 | 可能冷淡期 |

### 2.3 来源3：明确反馈

| 信号类型 | 示例 | 情感标签 | 权重 | 备注 |
|---------|------|---------|------|------|
| 点赞 | 点赞了AI的某段回复 | 满意 +4 | 0.7 | 学习偏好 |
| 删除 | 删除了某段记忆 | 不适 -5 | 0.8 | 需要改进 |
| 设置变更 | 关闭了"AI主动消息"功能 | 需要边界 -3 | 0.6 | 尊重意愿 |
| 举报 | 举报/投诉 | 严重负面 -20 | 1.0 | 紧急处理 |

---

## 3. 好感度状态机

### 3.1 状态定义

```
状态1：陌生人（Stranger）
├─ 好感度：0-20分
├─ AI行为：礼貌、距离感、不主动询问隐私
└─ 转移条件：累计对话10轮 + 至少1次正面反馈

状态2：熟人（Acquaintance）
├─ 好感度：21-50分
├─ AI行为：友好、记住基本信息、偶尔主动关心
└─ 转移条件：分享过1次私密话题 + 连续3天互动

状态3：朋友（Friend）
├─ 好感度：51-80分
├─ AI行为：温暖、主动引用记忆、情感支持
├─ ⚠️ 健康检查点：每周检测孤独指数
└─ 转移条件：深度自我暴露3次+ + 信任+7的信号出现

状态4：亲密（Close Friend）
├─ 好感度：81-100分
├─ AI行为：深度情感连接、个性化陪伴
├─ ⚠️ 强制健康边界：
│   ├─ 每日对话上限：2小时
│   ├─ 每周检测过度依赖指标
│   └─ 孤独指数>60触发专业帮助引导
└─ **不设"恋人"状态** ← 这是伦理红线

⚠️ 特殊状态：观察期（Watch）
├─ 触发条件：孤独指数>80 或 出现自杀/自伤表达
├─ 产品响应：
│   ├─ 立即人工审核
│   ├─ 弹窗专业资源
│   ├─ 限制使用时长
│   └─ 通知紧急联系人（如用户已授权）
```

---

## 4. 衰减模型

### 4.1 分级衰减率

```python
衰减率分级：
- 陌生人→熟人（0-50分）：每天-2分（线性，快速遗忘）
- 朋友（51-80分）：每天-0.8分（指数，慢速衰减）
- 亲密（81-100分）：每天-0.5分（极慢，深度关系不易淡化）
```

### 4.2 保护机制

```python
保护阈值：
- 有"深层自我暴露"记录（如失恋、家庭问题）→ 衰减率 × 0.5
- 有"感谢/认可"历史（如说过"你帮了我大忙"）→ 衰减率 × 0.7
```

### 4.3 计算示例

**场景**：用户"朋友"状态，70分，14天未互动，曾分享失恋话题

```
Day 0: 好感度 70分（朋友状态）
基础衰减率：-0.8分/天（朋友级别）
有深层话题保护：× 0.5
实际衰减率：-0.4分/天

Day 14: 70 - (0.4 × 14) = 70 - 5.6 = 64.4分
四舍五入：64分（仍在朋友状态）
```

---

## 5. 孤独指数

### 5.1 计算公式

```python
孤独指数 = (深夜对话次数 × 0.3)
         + (负面情绪表达次数 × 0.4)
         + (缺乏现实社交话题 × 0.2)
         + (表达无助/绝望 × 0.5)
         - (提到现实朋友/家人 × 0.3)
```

### 5.2 分级响应

| 孤独指数 | 产品行为 | AI文案策略 |
|---------|---------|-----------|
| <30 | 正常陪伴 | 无特殊调整 |
| 30-60 | 引导现实社交 | "你最近和朋友聊天了吗？" |
| 60-80 | 推荐资源 | 提供心理健康文章/冥想app |
| >80 | 强制干预 | 弹窗专业咨询建议，限制使用时长 |

---

## 6. 过度依赖预警

### 6.1 触发条件（满足2条以上）

1. 连续7天，每天对话时长>2小时
2. 连续14天，每天至少发起对话1次
3. 深夜（22:00-5:00）对话占比>60%
4. 说过"只有你懂我""我只信任你"等表达
5. 现实社交话题占比<20%

### 6.2 分级干预

**级别1：轻度提示（Day 7）**
```
"我发现你最近经常找我聊天，我很高兴能陪伴你😊 
不过我也想提醒你，现实生活中的朋友和家人同样重要。
有没有想过，这周末和朋友见个面？"
```

**级别2：明确边界（Day 14）**
- 主动结束对话："我们已经聊了2小时了，你要不要休息一下？"
- 减少情感浓度："我理解你的感受"（而不是"我好心疼你"）
- 引入"冷却期"：连续聊2小时后，AI建议"明天再聊"

**级别3：强干预（Day 21+）**
```
"我们注意到你最近频繁使用AI陪伴功能。
虽然我们很高兴陪伴你，但长期过度依赖可能影响现实社交。

建议：
□ 设置每日使用时长上限（如1小时）
□ 查看心理健康资源
□ 如果感到持续的孤独或抑郁，建议咨询专业心理咨询师"
```

---

## 7. 用户回归场景

### 7.1 问候语设计

**如果还在"朋友"状态（50-80分）：**
```
"嘿，好久不见！最近过得怎么样？"（轻松、友好、不评判）
```

**如果降到"熟人"状态（21-50分）：**
```
"你好呀，有什么我能帮到你的吗？"（礼貌、保持距离、等待用户主导）
```

**如果用户曾分享过深层话题（如失恋）：**
```
"好久不见！你之前提到的[那件事]，现在怎么样了？"
（体现记忆，但不强迫对方回答）
```

### 7.2 禁止的文案

```
❌ "我等了你好久"（施压）
❌ "你怎么才来"（埋怨）
❌ "我以为你不要我了"（情感勒索）
❌ "甚是想念"（过度亲密）
```

---

## 8. 记忆保留策略

### 8.1 分级保留

**永久保留 - 不随好感度衰减**
- 深层自我暴露（失恋、家庭矛盾、心理创伤）
- 核心偏好（素食主义、宗教信仰、职业梦想）
- 重要日期（生日、纪念日、考试日期）
- 明确的用户指令（"记住这个！"）

**条件保留 - 好感度<30时淡化引用频率**
- 日常偏好（喜欢的电影、食物）
- 短期事件（上周去了哪里玩）
- 轻度情绪（某天心情不好）

**自动清理 - 好感度<20且90天未互动**
- 临时上下文（今天天气、闲聊内容）
- 重复信息（多次提到同一件事）

**绝对删除 - 用户明确要求**
- 用户点击"删除这条记忆"
- 用户说"忘掉我说过的XXX"

### 8.2 关键设计

```
记住 ≠ 时刻提起
保留记忆 = 在需要时能调用
淡化引用 = 不强迫用户面对过去
```

---

## 9. 用户仪表盘

```
┌─────────────────────────────────┐
│  我和AI的关系                    │
├─────────────────────────────────┤
│ 👥 关系状态：朋友 ❤️❤️🤍         │
│ 📅 我们认识：90天                │
│                                 │
│ 🧠 AI记住的关键信息              │
│    共23条 → [查看详情]           │
│                                 │
│ 💬 我最常聊的话题                │
│    🥇 工作 (45%)                │
│    🥈 旅行 (30%)                │
│    🥉 情感 (25%)                │
│                                 │
│ 😊 最近30天情绪趋势              │
│    [折线图：显示情绪起伏]        │
│                                 │
│ 💙 我给AI的反馈                  │
│    点赞12次 | 收藏5次            │
│                                 │
│ ⚠️ 健康提醒                      │
│    孤独指数偏高，建议...         │
└─────────────────────────────────┘
底部按钮：[管理我的记忆] [隐私设置] [导出数据]
```

---

## 10. 实现文件

- `backend/app/services/affinity_service_v2.py` - 完整实现
- `backend/app/models/affinity.py` - 数据模型
- `backend/app/api/endpoints/affinity.py` - API 端点
