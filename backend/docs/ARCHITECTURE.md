# Affinity 项目架构图

## 1. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Frontend (React)                                │
│                           localhost:5173                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ ChatInterface│  │KnowledgeGraph│  │AffinityChart│  │MemoryStatus │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         │                │                │                │                │
│         └────────────────┴────────────────┴────────────────┘                │
│                                   │                                          │
│                              api.ts (HTTP/SSE)                               │
└───────────────────────────────────┼──────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Backend (FastAPI)                                  │
│                           localhost:8000                                     │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                         API Layer (endpoints/)                        │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │   │
│  │  │  auth   │ │  sse    │ │conversa-│ │  graph  │ │affinity │        │   │
│  │  │         │ │/message │ │  tion   │ │         │ │         │        │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                       Service Layer (services/)                       │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────────┐  │   │
│  │  │ Conversation │ │  Retrieval   │ │   Affinity   │ │    Graph    │  │   │
│  │  │   Service    │ │   Service    │ │   Service    │ │   Service   │  │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └─────────────┘  │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                  │   │
│  │  │ LLM Extract  │ │  IR Critic   │ │   Outbox     │                  │   │
│  │  │   Service    │ │   Service    │ │   Service    │                  │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
└────────────────────────────────────┼─────────────────────────────────────────┘
                                     │
        ┌────────────────────────────┼────────────────────────────┐
        │                            │                            │
        ▼                            ▼                            ▼
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│  PostgreSQL   │          │    Neo4j      │          │    Milvus     │
│   (主数据库)   │          │  (图谱存储)    │          │  (向量存储)    │
│               │          │               │          │               │
│ - users       │          │ - Entity 节点  │          │ - memories    │
│ - memories    │          │ - 关系边       │          │   collection  │
│ - affinity    │          │ - user_id 隔离 │          │ - embedding   │
│ - outbox      │          │               │          │   768 维      │
│ - sessions    │          │               │          │               │
└───────────────┘          └───────────────┘          └───────────────┘
        │
        │ Outbox 轮询
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                         Celery Worker (异步任务)                           │
│                                                                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │   outbox    │  │    decay    │  │ consistency │  │  deletion   │      │
│  │  (记忆处理)  │  │  (权重衰减)  │  │  (一致性)   │  │  (GDPR)     │      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐          ┌───────────────┐
│    Redis      │          │ SiliconFlow   │
│  (消息队列)    │          │   LLM API     │
│  (缓存)       │          │ (DeepSeek-V3) │
└───────────────┘          └───────────────┘
```

---

## 2. 用户输入后的运行流程（当前实现 - 串行）

```
用户输入: "谁住在海边"
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Step 1: API 接收请求                                  │
│  POST /api/v1/sse/message                                                   │
│  ├── 验证 JWT Token                                                         │
│  └── 获取 user_id                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Step 2: 幂等性检查                                    │
│  IdempotencyChecker.check_and_acquire(idempotency_key)                      │
│  ├── 检查 Redis 是否已处理                                                   │
│  └── 防止重复请求                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Step 3: 情感分析 (~1ms)                               │
│  EmotionAnalyzer.analyze(message)                                           │
│  ├── 关键词匹配                                                              │
│  └── 返回 {primary_emotion, valence, confidence}                            │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Step 4: 获取好感度 (~10ms)                            │
│  AffinityService.get_affinity(user_id)                                      │
│  ├── 查询 PostgreSQL affinity_history                                       │
│  └── 返回 {score, state}                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Step 5: Tier 路由 (~0ms)                              │
│  TierRouter.route(message, emotion, affinity_state)                         │
│  ├── 高情感 → Tier 1 (DeepSeek-V3)                                          │
│  ├── 简单问候 → Tier 3 (Qwen2.5-7B)                                         │
│  └── 默认 → Tier 2 (Qwen2.5-14B)                                            │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 6: 混合检索 (~500ms) ⚠️ 串行                          │
│  RetrievalService.hybrid_retrieve(user_id, message, affinity_score)         │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 6.1 Embedding (~450ms)                                               │    │
│  │     EmbeddingService.encode(message)                                 │    │
│  │     └── 调用 SiliconFlow API (BAAI/bge-m3)                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 6.2 Milvus 向量搜索 (~50ms)                                          │    │
│  │     milvus.search(query_embedding, top_k=50)                         │    │
│  │     └── 返回 50 个候选记忆 (cosine_sim)                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 6.3 图扩展 Graph Expansion (~0ms, 当前未启用)                         │    │
│  │     _graph_expand(vector_candidates, user_id)                        │    │
│  │     └── 获取邻居实体的关联记忆（Milvus 缺少 entity_id 字段）           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 6.4 Re-rank 重排序 (~1ms) ⭐ 四因子加权                               │    │
│  │     _rerank(memories, affinity_score)                                │    │
│  │                                                                      │    │
│  │     公式:                                                            │    │
│  │     final_score = cosine_sim    * 0.4  (语义相似度)                  │    │
│  │                 + edge_weight   * 0.3  (图谱边权重)                  │    │
│  │                 + affinity_bonus* 0.2  (好感度加成，仅正向记忆)       │    │
│  │                 + recency_score * 0.1  (时间新鲜度 exp(-days/30))    │    │
│  │                                                                      │    │
│  │     └── 按 final_score 降序排序，取 top_k=10                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 7: 图谱检索 (~1300ms) ⚠️ 串行                         │
│  RetrievalService.retrieve_entity_facts(user_id, message, graph_service)    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 7.1 实体抽取 (~800ms)                                                │    │
│  │     _extract_query_entities(query)                                   │    │
│  │     └── 调用 LLM 提取实体名称 ["海边"]                                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 7.2 Neo4j 查询 (~500ms)                                              │    │
│  │     ├── 1-hop: 直接关系                                              │    │
│  │     ├── 2-hop: 间接关系                                              │    │
│  │     └── 3-hop: 三跳关系                                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 7.3 语义扩展 (如果没找到实体)                                         │    │
│  │     _semantic_expand_query()                                         │    │
│  │     └── 查询所有 LIVES_IN 关系                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 8: 获取对话历史 (~50ms)                               │
│  _get_conversation_history(session_id, limit=5)                             │
│  ├── 仅 Hybrid 模式                                                         │
│  └── Graph-only 模式跳过（物理隔离）                                         │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 9: 构建 Prompt                                        │
│  _build_prompt(message, memories, affinity, emotion, entity_facts)          │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Prompt 结构:                                                         │    │
│  │ ├── 用户状态（好感度、情绪）                                          │    │
│  │ ├── 语气要求                                                         │    │
│  │ ├── 长期记忆（图谱事实）                                              │    │
│  │ ├── 长期记忆（向量检索）                                              │    │
│  │ ├── 短期记忆（对话历史，仅 Hybrid）                                   │    │
│  │ └── 回答规则                                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 10: LLM 生成回复 (~9800ms) ⚠️ 主要瓶颈                │
│  llm_client.chat.completions.create(stream=True)                            │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 调用 SiliconFlow API                                                 │    │
│  │ ├── Model: Pro/deepseek-ai/DeepSeek-V3.2                             │    │
│  │ ├── Max Tokens: 1000                                                 │    │
│  │ └── Stream: True (SSE)                                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 流式输出                                                             │    │
│  │ yield ConversationDelta(type="text", content=chunk)                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 11: Slow Path - 异步写入记忆                          │
│  (不阻塞用户响应)                                                            │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 11.1 写入 PostgreSQL + Outbox (原子事务)                             │    │
│  │      transaction_manager.create_memory_with_outbox()                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 11.2 Celery Worker 异步处理                                          │    │
│  │      ├── LLM 实体抽取                                                │    │
│  │      ├── IR Critic 校验                                              │    │
│  │      ├── 写入 Neo4j                                                  │    │
│  │      └── 写入 Milvus                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 12: 更新好感度                                        │
│  AffinityService.update_affinity(user_id, signals)                          │
│  └── delta = +0.01 (user_initiated) + emotion_bonus                         │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Step 13: 返回响应                                          │
│  yield ConversationDelta(type="done", metadata={...})                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 当前问题：串行执行

```
当前实现（串行）:
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  Embedding ──────────► Milvus 搜索 ──────────► 图谱检索 ──────────►      │
│   (~450ms)              (~50ms)                (~1300ms)                 │
│                                                                          │
│  总耗时: 450 + 50 + 1300 = 1800ms                                        │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

代码位置 (conversation_service.py):
```python
# 串行执行
retrieval_result = await self.retrieval_service.hybrid_retrieve(...)  # 先
entity_facts = await self.retrieval_service.retrieve_entity_facts(...) # 后
```

---

## 4. 优化方案：并行执行

```
优化后（并行）:
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ┌─────────────────────────────────────────┐                            │
│  │ 并行任务 1: 向量检索                      │                            │
│  │ Embedding ──────────► Milvus 搜索        │                            │
│  │  (~450ms)              (~50ms)           │                            │
│  └─────────────────────────────────────────┘                            │
│                                              ├──► 合并结果 ──► LLM 生成   │
│  ┌─────────────────────────────────────────┐                            │
│  │ 并行任务 2: 图谱检索                      │                            │
│  │ 实体抽取 ──────────► Neo4j 查询          │                            │
│  │  (~800ms)              (~500ms)          │                            │
│  └─────────────────────────────────────────┘                            │
│                                                                          │
│  总耗时: max(500, 1300) = 1300ms (节省 500ms)                            │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

优化代码:
```python
import asyncio

# 并行执行
retrieval_task = asyncio.create_task(
    self.retrieval_service.hybrid_retrieve(user_id, message, affinity.new_score)
)
entity_facts_task = asyncio.create_task(
    self.retrieval_service.retrieve_entity_facts(user_id, message, self.graph_service)
)

retrieval_result, entity_facts = await asyncio.gather(
    retrieval_task, entity_facts_task
)
```

---

## 5. 延迟分析

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          延迟分布                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  LLM 回复生成     ████████████████████████████████████████████  9833ms (84%)│
│  图谱事实检索     █████                                          1275ms (11%)│
│  Embedding       ██                                               456ms (4%) │
│  其他            █                                                 100ms (1%) │
│                                                                              │
│  总计: ~11.7s                                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

主要瓶颈: SiliconFlow API 调用 DeepSeek-V3 (84%)
```

---

## 6. 数据流向图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流向                                        │
└─────────────────────────────────────────────────────────────────────────────┘

用户消息: "昊哥住在大连"
         │
         ▼
┌─────────────────┐
│   Fast Path     │
│   (同步响应)     │
└────────┬────────┘
         │
         ├──────────────────────────────────────────────────────────────┐
         │                                                              │
         ▼                                                              ▼
┌─────────────────┐                                          ┌─────────────────┐
│  向量检索        │                                          │  图谱检索        │
│  (Milvus)       │                                          │  (Neo4j)        │
│                 │                                          │                 │
│  "昊哥住在大连"  │                                          │  昊哥 → 大连    │
│  → embedding    │                                          │  LIVES_IN       │
│  → 相似记忆      │                                          │                 │
└────────┬────────┘                                          └────────┬────────┘
         │                                                            │
         └──────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
                    ┌─────────────────┐
                    │   构建 Prompt    │
                    │   + LLM 生成     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   返回回复       │
                    │   (SSE 流式)     │
                    └─────────────────┘


         │
         ▼
┌─────────────────┐
│   Slow Path     │
│   (异步处理)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  PostgreSQL     │
│  memories 表    │
│  status=pending │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Outbox Event   │
│  (原子事务)      │
└────────┬────────┘
         │
         ▼ (Celery Worker 轮询)
┌─────────────────┐
│  LLM 实体抽取    │
│  IR Critic 校验  │
└────────┬────────┘
         │
         ├──────────────────────────────────────────────────────────────┐
         │                                                              │
         ▼                                                              ▼
┌─────────────────┐                                          ┌─────────────────┐
│  Neo4j          │                                          │  Milvus         │
│                 │                                          │                 │
│  CREATE (昊哥)  │                                          │  INSERT         │
│  CREATE (大连)  │                                          │  embedding      │
│  CREATE         │                                          │                 │
│  (昊哥)-[:LIVES_IN]->(大连)                                │                 │
└─────────────────┘                                          └─────────────────┘
         │                                                              │
         └──────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
                    ┌─────────────────┐
                    │  更新 memory    │
                    │  status=committed│
                    └─────────────────┘
```

---

## 7. 服务依赖关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          服务依赖关系                                        │
└─────────────────────────────────────────────────────────────────────────────┘

ConversationService
├── AffinityService ──────────► PostgreSQL (affinity_history)
├── RetrievalService
│   ├── EmbeddingService ─────► SiliconFlow API (BAAI/bge-m3)
│   ├── Milvus ───────────────► Milvus (memories collection)
│   └── GraphService ─────────► Neo4j (Entity, Relation)
├── EmotionAnalyzer ──────────► (本地关键词匹配)
├── TierRouter ───────────────► (本地规则)
├── TransactionManager ───────► PostgreSQL (memories, outbox)
├── IdempotencyChecker ───────► Redis
└── LLM Client ───────────────► SiliconFlow API (DeepSeek-V3)

Celery Worker (outbox.py)
├── LLMExtractionService ─────► SiliconFlow API (DeepSeek-V3)
├── IRCriticService ──────────► (本地规则校验)
├── GraphService ─────────────► Neo4j
└── Milvus ───────────────────► Milvus
```

---

## 8. 总结

**当前状态**:
- ❌ 向量检索和图谱检索是**串行执行**
- ❌ 主要瓶颈是 LLM API 调用 (84%)

**优化建议**:
1. ✅ 并行执行向量检索和图谱检索（可节省 ~500ms）
2. ✅ 本地部署 LLM 或使用更快的 API
3. ✅ 对常见问候语缓存回复
4. ✅ 优化 Tier 路由，更多使用轻量模型
