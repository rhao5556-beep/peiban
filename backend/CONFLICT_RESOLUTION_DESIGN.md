# å†²çªè®°å¿†å¤„ç†æ–¹æ¡ˆ

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šç³»ç»Ÿè®°å½•äº†"å–œæ¬¢èŒ¶"å’Œ"è®¨åŒèŒ¶"ä¸¤æ¡çŸ›ç›¾è®°å¿†ï¼Œå½“è¯¢é—®æ—¶ç³»ç»Ÿå›ç­”"å–œæ¬¢æ·¡æ·¡çš„èŒ¶"ã€‚

**æ ¸å¿ƒé—®é¢˜**ï¼šç³»ç»Ÿå¦‚ä½•åˆ¤å®šå†²çªè®°å¿†çš„ä¼˜å…ˆçº§ï¼Ÿ

---

## å½“å‰ç³»ç»Ÿè¡Œä¸ºåˆ†æ

### 1. æ£€ç´¢é˜¶æ®µ

```python
# å‘é‡æ£€ç´¢
memories = [
    {"content": "æˆ‘å–œæ¬¢èŒ¶", "similarity": 0.85, "created_at": "2026-01-10"},
    {"content": "æˆ‘è®¨åŒèŒ¶", "similarity": 0.83, "created_at": "2026-01-15"},
    {"content": "æˆ‘å–œæ¬¢æ·¡æ·¡çš„èŒ¶", "similarity": 0.90, "created_at": "2026-01-18"}
]

# Re-rankï¼ˆåŸºäºå¥½æ„Ÿåº¦ + æ—¶é—´è¡°å‡ï¼‰
ranked_memories = rerank(memories, affinity_score=0.6)
# â†’ å¯èƒ½è¿”å›æ‰€æœ‰ä¸‰æ¡è®°å¿†
```

**é—®é¢˜**ï¼š
- âŒ æ²¡æœ‰å†²çªæ£€æµ‹
- âŒ æ²¡æœ‰å»é‡æˆ–åˆå¹¶
- âŒ ç›´æ¥æŠŠçŸ›ç›¾ä¿¡æ¯ä¼ ç»™ LLM

### 2. LLM ç”Ÿæˆé˜¶æ®µ

```
Prompt:
=== é•¿æœŸè®°å¿† ===
- ä½ å–œæ¬¢èŒ¶
- ä½ è®¨åŒèŒ¶
- ä½ å–œæ¬¢æ·¡æ·¡çš„èŒ¶

ç”¨æˆ·: æˆ‘æ˜¯å–œæ¬¢èŒ¶è¿˜æ˜¯è®¨åŒèŒ¶
```

**LLM çš„éšå¼å¤„ç†**ï¼š
1. çœ‹åˆ°ä¸‰æ¡è®°å¿†
2. å‘ç°"å–œæ¬¢æ·¡æ·¡çš„èŒ¶"æ›´å…·ä½“
3. è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæŠ˜ä¸­/ç²¾ç¡®çš„è¡¨è¿°
4. é€‰æ‹©è¿™ä¸ªç­”æ¡ˆ

**é—®é¢˜**ï¼š
- âŒ ä¾èµ– LLM çš„éšå¼æ¨ç†ï¼ˆä¸å¯æ§ï¼‰
- âŒ æ²¡æœ‰æ˜ç¡®çš„å†²çªè§£å†³è§„åˆ™
- âŒ ç”¨æˆ·æ— æ³•ç†è§£ç³»ç»Ÿçš„åˆ¤å®šé€»è¾‘

---

## è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå†²çªæ£€æµ‹ + æ¾„æ¸…ï¼ˆæ¨èï¼‰â­â­â­â­â­

**æ ¸å¿ƒæ€è·¯**ï¼šä¸»åŠ¨æ£€æµ‹å†²çªï¼Œè¯¢é—®ç”¨æˆ·æ¾„æ¸…

#### 1.1 æ£€æµ‹å†²çª

```python
from app.services.conflict_detector_service import ConflictDetector

detector = ConflictDetector()

# æ£€æµ‹å†²çª
conflicts = detector.detect_conflicts(memories)

# ç»“æœ
conflicts = [
    {
        "memory_1": {"content": "æˆ‘å–œæ¬¢èŒ¶", "created_at": "2026-01-10"},
        "memory_2": {"content": "æˆ‘è®¨åŒèŒ¶", "created_at": "2026-01-15"},
        "conflict_type": "opposite",
        "common_topic": ["èŒ¶"],
        "confidence": 0.9,
        "newer_memory": {"content": "æˆ‘è®¨åŒèŒ¶", ...}
    }
]
```

#### 1.2 ç”Ÿæˆæ¾„æ¸…é—®é¢˜

```python
if conflicts:
    clarification = detector.generate_clarification_prompt(conflicts[0])
    
    # è¿”å›æ¾„æ¸…é—®é¢˜è€Œä¸æ˜¯ç›´æ¥å›ç­”
    return clarification
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
ç”¨æˆ·: æˆ‘æ˜¯å–œæ¬¢èŒ¶è¿˜æ˜¯è®¨åŒèŒ¶

AI: æˆ‘è®°å¾—ä½ ä¹‹å‰è¯´è¿‡ï¼š
1. æˆ‘å–œæ¬¢èŒ¶ï¼ˆ1æœˆ10æ—¥ï¼‰
2. æˆ‘è®¨åŒèŒ¶ï¼ˆ1æœˆ15æ—¥ï¼‰

è¿™ä¸¤ä¸ªè¯´æ³•æœ‰ç‚¹çŸ›ç›¾ã€‚èƒ½å¸®æˆ‘ç¡®è®¤ä¸€ä¸‹å—ï¼Ÿ

é€‰é¡¹ï¼š
A. å–œæ¬¢èŒ¶
B. è®¨åŒèŒ¶
C. éƒ½ä¸å¯¹ï¼Œå®é™…æƒ…å†µæ˜¯...
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆä¸»åŠ¨æ¾„æ¸…ï¼‰
- âœ… æé«˜è®°å¿†å‡†ç¡®æ€§
- âœ… å¢å¼ºä¿¡ä»»æ„Ÿ

**ç¼ºç‚¹**ï¼š
- âš ï¸  éœ€è¦é¢å¤–çš„äº¤äº’è½®æ¬¡
- âš ï¸  å®ç°å¤æ‚åº¦ä¸­ç­‰

---

### æ–¹æ¡ˆ 2ï¼šæ—¶é—´ä¼˜å…ˆ + æ ‡è®°å†²çª â­â­â­â­

**æ ¸å¿ƒæ€è·¯**ï¼šä¼˜å…ˆä½¿ç”¨æœ€æ–°è®°å¿†ï¼Œä½†æ ‡è®°å­˜åœ¨å†²çª

#### 2.1 è§£å†³å†²çª

```python
if conflicts:
    resolution = detector.resolve_conflict_with_time(conflicts[0])
    
    if resolution["action"] == "use_newer":
        # ä½¿ç”¨æœ€æ–°çš„è®°å¿†
        preferred_memory = resolution["preferred_memory"]
        
        # åœ¨ Prompt ä¸­æ ‡è®°å†²çª
        prompt += f"""
ã€æ³¨æ„ã€‘æ£€æµ‹åˆ°çŸ›ç›¾ä¿¡æ¯ï¼š
- æ—§è®°å¿†: {older_memory['content']}
- æ–°è®°å¿†: {newer_memory['content']}

ä¼˜å…ˆä½¿ç”¨æ–°è®°å¿†ï¼Œä½†å¯ä»¥æé†’ç”¨æˆ·å­˜åœ¨çŸ›ç›¾ã€‚
"""
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
ç”¨æˆ·: æˆ‘æ˜¯å–œæ¬¢èŒ¶è¿˜æ˜¯è®¨åŒèŒ¶

AI: æ ¹æ®ä½ æœ€è¿‘çš„è¯´æ³•ï¼ˆ1æœˆ15æ—¥ï¼‰ï¼Œä½ æ˜¯è®¨åŒèŒ¶çš„ã€‚

ä¸è¿‡æˆ‘æ³¨æ„åˆ°ä½ ä¹‹å‰ï¼ˆ1æœˆ10æ—¥ï¼‰è¯´è¿‡å–œæ¬¢èŒ¶ï¼Œæƒ³æ³•æ”¹å˜äº†å—ï¼Ÿ
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸éœ€è¦é¢å¤–äº¤äº’
- âœ… æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… å®ç°ç®€å•

**ç¼ºç‚¹**ï¼š
- âš ï¸  å¯èƒ½é€‰é”™ï¼ˆæœ€æ–°çš„ä¸ä¸€å®šæ˜¯å¯¹çš„ï¼‰
- âš ï¸  ç”¨æˆ·å¯èƒ½ä¸æ³¨æ„æé†’

---

### æ–¹æ¡ˆ 3ï¼šè¯­ä¹‰åˆå¹¶ + ç²¾ç¡®åŒ– â­â­â­

**æ ¸å¿ƒæ€è·¯**ï¼šå°è¯•åˆå¹¶çŸ›ç›¾ä¿¡æ¯ï¼Œæ‰¾åˆ°æ›´ç²¾ç¡®çš„è¡¨è¿°

#### 3.1 è¯­ä¹‰åˆå¹¶

```python
# æ£€æµ‹åˆ°å†²çª
conflict = {
    "memory_1": "æˆ‘å–œæ¬¢èŒ¶",
    "memory_2": "æˆ‘è®¨åŒèŒ¶",
    "memory_3": "æˆ‘å–œæ¬¢æ·¡æ·¡çš„èŒ¶"
}

# å°è¯•åˆå¹¶
merged = semantic_merge(conflict)
# â†’ "æˆ‘å–œæ¬¢æ·¡æ·¡çš„èŒ¶ï¼Œä½†ä¸å–œæ¬¢æµ“èŒ¶"
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
ç”¨æˆ·: æˆ‘æ˜¯å–œæ¬¢èŒ¶è¿˜æ˜¯è®¨åŒèŒ¶

AI: æ ¹æ®ä½ çš„æè¿°ï¼Œä½ å–œæ¬¢æ·¡æ·¡çš„èŒ¶ï¼Œä½†ä¸å¤ªå–œæ¬¢æµ“èŒ¶æˆ–æŸäº›ç§ç±»çš„èŒ¶ã€‚

æ˜¯è¿™æ ·å—ï¼Ÿ
```

**ä¼˜ç‚¹**ï¼š
- âœ… å°è¯•ç†è§£ç”¨æˆ·çœŸå®æ„å›¾
- âœ… æä¾›æ›´ç²¾ç¡®çš„ç­”æ¡ˆ

**ç¼ºç‚¹**ï¼š
- âŒ å¯èƒ½è¿‡åº¦æ¨ç†ï¼ˆå¹»è§‰é£é™©ï¼‰
- âŒ å®ç°å¤æ‚åº¦é«˜
- âŒ ä¸ä¸€å®šå‡†ç¡®

---

### æ–¹æ¡ˆ 4ï¼šPrompt æŒ‡å¯¼ + LLM åˆ¤æ–­ â­â­

**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨ Prompt ä¸­æ·»åŠ å†²çªå¤„ç†è§„åˆ™ï¼Œè®© LLM è‡ªå·±åˆ¤æ–­

#### 4.1 Prompt å¢å¼º

```python
prompt += """
ã€å†²çªå¤„ç†è§„åˆ™ã€‘
å¦‚æœæ£€æµ‹åˆ°çŸ›ç›¾ä¿¡æ¯ï¼š
1. ä¼˜å…ˆä½¿ç”¨æœ€æ–°çš„è®°å¿†
2. å¦‚æœæ— æ³•åˆ¤æ–­ï¼Œä¸»åŠ¨è¯¢é—®ç”¨æˆ·æ¾„æ¸…
3. å¯ä»¥å°è¯•ç†è§£æ˜¯å¦æœ‰æ›´ç²¾ç¡®çš„è¡¨è¿°ï¼ˆå¦‚"å–œæ¬¢æ·¡èŒ¶ä½†ä¸å–œæ¬¢æµ“èŒ¶"ï¼‰

ç¤ºä¾‹ï¼š
ç”¨æˆ·: æˆ‘æ˜¯å–œæ¬¢èŒ¶è¿˜æ˜¯è®¨åŒèŒ¶
è®°å¿†: "æˆ‘å–œæ¬¢èŒ¶"ï¼ˆ1æœˆ10æ—¥ï¼‰ã€"æˆ‘è®¨åŒèŒ¶"ï¼ˆ1æœˆ15æ—¥ï¼‰

æ­£ç¡®å›ç­”: "æˆ‘è®°å¾—ä½ æœ€è¿‘ï¼ˆ1æœˆ15æ—¥ï¼‰è¯´è¿‡è®¨åŒèŒ¶ï¼Œä½†ä¹‹å‰ï¼ˆ1æœˆ10æ—¥ï¼‰è¯´è¿‡å–œæ¬¢èŒ¶ã€‚æƒ³æ³•æ”¹å˜äº†å—ï¼Ÿ"
"""
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®ç°ç®€å•ï¼ˆåªéœ€ä¿®æ”¹ Promptï¼‰
- âœ… çµæ´»ï¼ˆLLM å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ ä¸å¯æ§ï¼ˆä¾èµ– LLM çš„ç†è§£ï¼‰
- âŒ å¯èƒ½ä¸ä¸€è‡´ï¼ˆä¸åŒæ¨¡å‹è¡¨ç°ä¸åŒï¼‰
- âŒ æ— æ³•ä¿è¯éµå®ˆè§„åˆ™

---

## æ¨èæ–¹æ¡ˆ

### ğŸ¯ çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å®æ–½ï¼‰

**æ–¹æ¡ˆ 2 + æ–¹æ¡ˆ 4 ç»„åˆ**ï¼š
1. åœ¨æ£€ç´¢åæ·»åŠ ç®€å•çš„å†²çªæ£€æµ‹
2. åœ¨ Prompt ä¸­æ·»åŠ å†²çªå¤„ç†æŒ‡å¯¼
3. ä¼˜å…ˆä½¿ç”¨æœ€æ–°è®°å¿†ï¼Œä½†æé†’ç”¨æˆ·å­˜åœ¨çŸ›ç›¾

**å®æ–½æ­¥éª¤**ï¼š

1. **ä¿®æ”¹ `_build_prompt()` æ–¹æ³•**
```python
# æ£€æµ‹å†²çªï¼ˆç®€åŒ–ç‰ˆï¼‰
conflicts = self._detect_simple_conflicts(memories)

if conflicts:
    prompt += """
ã€æ³¨æ„ã€‘æ£€æµ‹åˆ°çŸ›ç›¾ä¿¡æ¯ï¼Œè¯·éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
1. ä¼˜å…ˆä½¿ç”¨æœ€æ–°çš„è®°å¿†
2. æé†’ç”¨æˆ·å­˜åœ¨çŸ›ç›¾ï¼Œè¯¢é—®æ˜¯å¦æƒ³æ³•æ”¹å˜
3. å¦‚æœæœ‰æ›´ç²¾ç¡®çš„è¡¨è¿°ï¼ˆå¦‚"å–œæ¬¢æ·¡èŒ¶"ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨

ç¤ºä¾‹ï¼š
"æ ¹æ®ä½ æœ€è¿‘çš„è¯´æ³•ï¼Œä½ æ˜¯è®¨åŒèŒ¶çš„ã€‚ä¸è¿‡æˆ‘æ³¨æ„åˆ°ä½ ä¹‹å‰è¯´è¿‡å–œæ¬¢èŒ¶ï¼Œæƒ³æ³•æ”¹å˜äº†å—ï¼Ÿ"
"""
```

2. **æ·»åŠ ç®€å•å†²çªæ£€æµ‹**
```python
def _detect_simple_conflicts(self, memories: list) -> list:
    """ç®€å•çš„å†²çªæ£€æµ‹ï¼ˆåŸºäºå…³é”®è¯ï¼‰"""
    conflicts = []
    
    opposite_pairs = [
        ("å–œæ¬¢", "è®¨åŒ"),
        ("å–œæ¬¢", "ä¸å–œæ¬¢"),
        ("çˆ±", "æ¨"),
    ]
    
    for i, mem1 in enumerate(memories):
        for mem2 in memories[i+1:]:
            for word1, word2 in opposite_pairs:
                if (word1 in mem1.content and word2 in mem2.content):
                    conflicts.append((mem1, mem2))
    
    return conflicts
```

**å·¥ä½œé‡**ï¼šå°ï¼ˆ1-2å°æ—¶ï¼‰

---

### ğŸš€ é•¿æœŸæ–¹æ¡ˆï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

**æ–¹æ¡ˆ 1ï¼šå®Œæ•´çš„å†²çªæ£€æµ‹ + æ¾„æ¸…ç³»ç»Ÿ**

1. å®æ–½å®Œæ•´çš„ `ConflictDetector` æœåŠ¡
2. åœ¨å¯¹è¯æµç¨‹ä¸­é›†æˆå†²çªæ£€æµ‹
3. å½“æ£€æµ‹åˆ°å†²çªæ—¶ï¼Œä¸»åŠ¨è¯¢é—®ç”¨æˆ·æ¾„æ¸…
4. è®°å½•ç”¨æˆ·çš„æ¾„æ¸…ç»“æœï¼Œæ›´æ–°è®°å¿†

**å®æ–½æ­¥éª¤**ï¼š

1. **é›†æˆå†²çªæ£€æµ‹å™¨**
```python
# åœ¨ ConversationService ä¸­
from app.services.conflict_detector_service import ConflictDetector

self.conflict_detector = ConflictDetector()

# åœ¨æ£€ç´¢åæ£€æµ‹å†²çª
conflicts = self.conflict_detector.detect_conflicts(ranked_memories)

if conflicts and self._should_clarify(conflicts[0]):
    # ç”Ÿæˆæ¾„æ¸…é—®é¢˜
    clarification = self.conflict_detector.generate_clarification_prompt(conflicts[0])
    return clarification
```

2. **æ·»åŠ æ¾„æ¸…å¤„ç†æµç¨‹**
```python
# ç”¨æˆ·å›ç­”æ¾„æ¸…é—®é¢˜å
if is_clarification_response:
    # æ›´æ–°è®°å¿†
    await self._update_memory_with_clarification(user_choice)
    
    # æ ‡è®°æ—§è®°å¿†ä¸º"å·²åºŸå¼ƒ"
    await self._mark_memory_as_deprecated(old_memory_id)
```

3. **æ·»åŠ å†²çªæ ‡è®°**
```python
# åœ¨æ•°æ®åº“ä¸­æ·»åŠ å­—æ®µ
ALTER TABLE memories ADD COLUMN conflict_status VARCHAR(20);
-- å¯èƒ½çš„å€¼ï¼š'active', 'deprecated', 'conflicted'
```

**å·¥ä½œé‡**ï¼šå¤§ï¼ˆ1-2å¤©ï¼‰

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1ï¼šåŸºæœ¬å†²çªæ£€æµ‹

```python
memories = [
    {"content": "æˆ‘å–œæ¬¢èŒ¶", "created_at": "2026-01-10"},
    {"content": "æˆ‘è®¨åŒèŒ¶", "created_at": "2026-01-15"}
]

conflicts = detector.detect_conflicts(memories)

assert len(conflicts) == 1
assert conflicts[0]["conflict_type"] == "opposite"
assert conflicts[0]["newer_memory"]["content"] == "æˆ‘è®¨åŒèŒ¶"
```

### æµ‹è¯• 2ï¼šæ¾„æ¸…é—®é¢˜ç”Ÿæˆ

```python
clarification = detector.generate_clarification_prompt(conflicts[0])

assert "çŸ›ç›¾" in clarification
assert "æˆ‘å–œæ¬¢èŒ¶" in clarification
assert "æˆ‘è®¨åŒèŒ¶" in clarification
```

### æµ‹è¯• 3ï¼šæ—¶é—´ä¼˜å…ˆè§£å†³

```python
resolution = detector.resolve_conflict_with_time(conflicts[0])

assert resolution["action"] == "use_newer"
assert resolution["preferred_memory"]["content"] == "æˆ‘è®¨åŒèŒ¶"
```

---

## æ€»ç»“

### å½“å‰é—®é¢˜

âŒ ç³»ç»Ÿæ²¡æœ‰å†²çªæ£€æµ‹æœºåˆ¶
âŒ ä¾èµ– LLM çš„éšå¼æ¨ç†ï¼ˆä¸å¯æ§ï¼‰
âŒ ç”¨æˆ·æ— æ³•ç†è§£åˆ¤å®šé€»è¾‘

### æ¨èæ–¹æ¡ˆ

âœ… **çŸ­æœŸ**ï¼šPrompt æŒ‡å¯¼ + æ—¶é—´ä¼˜å…ˆï¼ˆ1-2å°æ—¶ï¼‰
âœ… **é•¿æœŸ**ï¼šå®Œæ•´å†²çªæ£€æµ‹ + æ¾„æ¸…ç³»ç»Ÿï¼ˆ1-2å¤©ï¼‰

### é¢„æœŸæ•ˆæœ

- ç”¨æˆ·ä½“éªŒæå‡ï¼šä¸»åŠ¨æ¾„æ¸…çŸ›ç›¾
- è®°å¿†å‡†ç¡®æ€§æå‡ï¼šåŠæ—¶æ›´æ–°è¿‡æ—¶ä¿¡æ¯
- ä¿¡ä»»åº¦æå‡ï¼šé€æ˜çš„åˆ¤å®šé€»è¾‘

---

**æœ€åæ›´æ–°**ï¼š2026-01-19
**çŠ¶æ€**ï¼šè®¾è®¡å®Œæˆï¼Œç­‰å¾…å®æ–½
