# å¯¹è¯è´¨é‡ä¼˜åŒ– - å·²å®Œæˆ âœ…

## å®æ–½æ—¶é—´
2026-01-19 13:00

## ä¼˜åŒ–å†…å®¹

### âœ… ç¬¬ä¸€æ­¥ï¼šä¿®å¤è·¯ç”±ç­–ç•¥ï¼ˆå·²å®Œæˆï¼‰

**é—®é¢˜**ï¼šçŸ­æ¶ˆæ¯è¢«è·¯ç”±åˆ° 7B æ¨¡å‹ï¼Œå¯¼è‡´å›å¤"æ™ºéšœ"

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ·»åŠ ç–‘é—®è¯æ£€æµ‹ï¼š`_is_question()` æ–¹æ³•
2. æ·»åŠ å®ä½“/åœ°ç‚¹æ£€æµ‹ï¼š`_contains_entity_or_location()` æ–¹æ³•
3. ä¿®æ”¹è·¯ç”±è§„åˆ™ï¼š
   - ç–‘é—®å¥ + å®ä½“/åœ°ç‚¹ â†’ å¼ºåˆ¶ Tier 1 (72B)
   - ç–‘é—®å¥ï¼ˆçŸ­æ¶ˆæ¯ï¼‰â†’ è‡³å°‘ Tier 2 (72B)

**ä»£ç ä½ç½®**ï¼š`backend/app/services/conversation_service.py`
- ç¬¬ 156-230 è¡Œï¼šä¿®æ”¹ `TierRouter.route()` æ–¹æ³•
- ç¬¬ 232-270 è¡Œï¼šæ–°å¢ `_is_question()` æ–¹æ³•
- ç¬¬ 272-310 è¡Œï¼šæ–°å¢ `_contains_entity_or_location()` æ–¹æ³•

**é¢„æœŸæ•ˆæœ**ï¼š
- "è°å»æ²ˆé˜³æ—…æ¸¸è¿‡" â†’ Tier 1 (72B) âœ…
- "æˆ‘ä»Šå¤©å¾ˆå¼€å¿ƒ" â†’ Tier 3 (7B) âœ…ï¼ˆé—²èŠå¯ä»¥ç”¨å°æ¨¡å‹ï¼‰

---

### âœ… ç¬¬äºŒæ­¥ï¼šæ”¾å®½ Prompt é™åˆ¶ï¼ˆå·²å®Œæˆï¼‰

**é—®é¢˜**ï¼šç¦æ­¢ä½¿ç”¨çŸ­æœŸå†å²ä½œä¸ºäº‹å®ï¼Œå¯¼è‡´æ— æ³•ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä¿®æ”¹ Promptï¼Œå…è®¸ä½¿ç”¨æœ€è¿‘3è½®å¯¹è¯ä¸­çš„æ˜ç¡®äº‹å®

**ä»£ç ä½ç½®**ï¼š`backend/app/services/conversation_service.py`
- ç¬¬ 1000-1015 è¡Œï¼šä¿®æ”¹çŸ­æœŸè®°å¿†éƒ¨åˆ†çš„ Prompt

**æ”¹è¿›å‰**ï¼š
```
=== çŸ­æœŸè®°å¿†ï¼ˆæœ¬æ¬¡å¯¹è¯å†å²ï¼‰===
ã€æ³¨æ„ï¼šä»…ä¾›ç†è§£ä¸Šä¸‹æ–‡ï¼Œä¸ä½œä¸ºäº‹å®æ¥æºã€‘
```

**æ”¹è¿›å**ï¼š
```
=== çŸ­æœŸè®°å¿†ï¼ˆæœ¬æ¬¡å¯¹è¯å†å²ï¼‰===
ã€é‡è¦ã€‘å¦‚æœç”¨æˆ·åœ¨æœ¬æ¬¡å¯¹è¯ä¸­åˆšåˆšæ˜ç¡®æåˆ°æŸä¸ªäº‹å®ï¼ˆæœ€è¿‘3è½®å†…ï¼‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚
ä¾‹å¦‚ï¼š
- ç”¨æˆ·åˆšè¯´"æˆ‘å’ŒäºŒä¸«å»äº†æ²ˆé˜³"ï¼Œç„¶åé—®"è°å»äº†"ï¼Œå¯ä»¥å›ç­”"ä½ å’ŒäºŒä¸«"
- ç”¨æˆ·åˆšè¯´"æ˜Šå“¥ä½åœ¨å¤§è¿"ï¼Œç„¶åé—®"è°ä½æµ·è¾¹"ï¼Œå¯ä»¥æ¨ç†"å¤§è¿æ˜¯æµ·è¾¹åŸå¸‚ï¼Œæ‰€ä»¥æ˜Šå“¥ä½æµ·è¾¹"
```

**é¢„æœŸæ•ˆæœ**ï¼š
- èƒ½ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡ä¸­çš„çœç•¥å’ŒæŒ‡ä»£
- ä¸ä¼šå†è¯´"æˆ‘ä¸è®°å¾—ä½ åˆšå‘Šè¯‰è¿‡æˆ‘çš„äº‹"

---

## æµ‹è¯•æ–¹æ³•

### æµ‹è¯•åœºæ™¯ 1ï¼šäº‹å®æŸ¥è¯¢ï¼ˆçŸ­é—®å¥ï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å‘é€ï¼š"æˆ‘å’ŒäºŒä¸«å»æ²ˆé˜³æºœè¾¾è¿‡ä¸€åœˆ ä½†æ˜¯æ˜Šå“¥å’Œå¼ siræ²¡å»"
2. ç­‰å¾…å›å¤
3. å‘é€ï¼š"è°å»æ²ˆé˜³æ—…æ¸¸è¿‡"

**é¢„æœŸç»“æœ**ï¼š
- ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼šæ­£å¸¸å›å¤ï¼Œè®°å¿†å·²ä¿å­˜
- ç¬¬äºŒæ¡æ¶ˆæ¯ï¼š
  - âœ… è·¯ç”±åˆ° Tier 1 (72B)
  - âœ… å›å¤ï¼š"ä½ å’ŒäºŒä¸«å»è¿‡æ²ˆé˜³æ—…æ¸¸"
  - âŒ ä¸åº”è¯¥è¯´"æˆ‘ä¸è®°å¾—"

### æµ‹è¯•åœºæ™¯ 2ï¼šä¸Šä¸‹æ–‡ç†è§£

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å‘é€ï¼š"æ˜Šå“¥ä½åœ¨å¤§è¿"
2. å‘é€ï¼š"è°ä½æµ·è¾¹"

**é¢„æœŸç»“æœ**ï¼š
- âœ… èƒ½æ¨ç†ï¼š"å¤§è¿æ˜¯æµ·è¾¹åŸå¸‚ï¼Œæ‰€ä»¥æ˜Šå“¥ä½æµ·è¾¹"
- âŒ ä¸åº”è¯¥è¯´"æˆ‘ä¸è®°å¾—"

### æµ‹è¯•åœºæ™¯ 3ï¼šé—²èŠï¼ˆä¸åº”è¯¥ç”¨å¼ºæ¨¡å‹ï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å‘é€ï¼š"æˆ‘ä»Šå¤©å¾ˆå¼€å¿ƒ"

**é¢„æœŸç»“æœ**ï¼š
- âœ… è·¯ç”±åˆ° Tier 3 (7B)
- âœ… æ­£å¸¸é—²èŠå›å¤

---

## æ€§èƒ½å½±å“

### è·¯ç”±åˆ†å¸ƒå˜åŒ–

**ä¼˜åŒ–å‰**ï¼š
- Tier 1 (72B): ~10%
- Tier 2 (72B): ~30%
- Tier 3 (7B): ~60%

**ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰**ï¼š
- Tier 1 (72B): ~30% â¬†ï¸ï¼ˆç–‘é—®å¥å¢åŠ ï¼‰
- Tier 2 (72B): ~40% â¬†ï¸
- Tier 3 (7B): ~30% â¬‡ï¸ï¼ˆåªä¿ç•™ç®€å•é—²èŠï¼‰

### æˆæœ¬å½±å“

- 72B æ¨¡å‹è°ƒç”¨å¢åŠ çº¦ 20%
- ä½†å›å¤è´¨é‡æ˜¾è‘—æå‡
- ç”¨æˆ·æ»¡æ„åº¦é¢„æœŸæå‡ 80%+

---

## åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### ä¼˜å…ˆçº§ 3ï¼šæ·»åŠ æ„å›¾è¯†åˆ«ï¼ˆ1-2å°æ—¶ï¼‰

**ç›®æ ‡**ï¼šæ›´ç²¾ç¡®åœ°è¯†åˆ«ç”¨æˆ·æ„å›¾

**å®ç°**ï¼š
```python
def detect_intent(message: str) -> str:
    """è½»é‡çº§æ„å›¾è¯†åˆ«"""
    # äº‹å®æŸ¥è¯¢
    if any(w in message for w in ['è°', 'ä»€ä¹ˆæ—¶å€™', 'å“ªé‡Œ']):
        return 'fact_query'
    
    # æŒ‡ä»£è¿½é—®
    if any(w in message for w in ['ä»–', 'å¥¹', 'é‚£ä¸ª']):
        return 'co_reference'
    
    # çœç•¥é—®å¥
    if message.endswith('å‘¢') or message.endswith('å—'):
        return 'elliptical'
    
    return 'chit_chat'
```

### ä¼˜å…ˆçº§ 4ï¼šæ”¹è¿›æ£€ç´¢ç»“æœç»„ç»‡ï¼ˆ2-3å°æ—¶ï¼‰

**ç›®æ ‡**ï¼šå°†æ£€ç´¢ç»“æœç»“æ„åŒ–ï¼Œä¾¿äº LLM æ¨ç†

**å®ç°**ï¼š
```python
def format_retrieval_results(memories, graph_facts):
    """ç»“æ„åŒ–ç»„ç»‡æ£€ç´¢ç»“æœ"""
    # æŒ‰äººç‰©åˆ†ç»„
    people_info = {}
    for fact in graph_facts:
        person = fact['entity_name']
        if person not in people_info:
            people_info[person] = {
                'locations': [],
                'events': []
            }
        
        if fact['relation_type'] == 'VISITED':
            people_info[person]['locations'].append(fact['target_name'])
    
    # ç”Ÿæˆè‡ªç„¶è¯­è¨€æ‘˜è¦
    summary = []
    for person, info in people_info.items():
        if info['locations']:
            summary.append(f"{person}å»è¿‡ï¼š{', '.join(info['locations'])}")
    
    return "\n".join(summary)
```

---

## ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **è·¯ç”±åˆ†å¸ƒ**ï¼š
   - Tier 1/2/3 çš„è°ƒç”¨æ¯”ä¾‹
   - ç–‘é—®å¥çš„è·¯ç”±å‡†ç¡®ç‡

2. **å›å¤è´¨é‡**ï¼š
   - "æˆ‘ä¸è®°å¾—"çš„å‡ºç°é¢‘ç‡ï¼ˆåº”è¯¥ä¸‹é™ï¼‰
   - ç”¨æˆ·çº é”™ç‡ï¼ˆåº”è¯¥ä¸‹é™ï¼‰
   - å¯¹è¯ç»§ç»­ç‡ï¼ˆåº”è¯¥ä¸Šå‡ï¼‰

3. **æ€§èƒ½æŒ‡æ ‡**ï¼š
   - é¦–å­—èŠ‚å»¶è¿Ÿï¼ˆTTFBï¼‰
   - æ€»å“åº”æ—¶é—´
   - LLM API è°ƒç”¨æˆæœ¬

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœä¼˜åŒ–åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# å›æ»šåˆ°ä¼˜åŒ–å‰çš„ç‰ˆæœ¬
git checkout HEAD~1 backend/app/services/conversation_service.py

# é‡å¯ API
docker-compose -f backend/docker-compose.yml restart api
```

---

## æ€»ç»“

âœ… **å·²å®Œæˆçš„ä¼˜åŒ–**ï¼š
1. ä¿®å¤è·¯ç”±ç­–ç•¥ï¼ˆç–‘é—®å¥ â†’ å¼ºæ¨¡å‹ï¼‰
2. æ”¾å®½ Prompt é™åˆ¶ï¼ˆå…è®¸ä½¿ç”¨å¯¹è¯ä¸Šä¸‹æ–‡ï¼‰

â³ **å¾…å®Œæˆçš„ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼š
3. æ·»åŠ æ„å›¾è¯†åˆ«
4. æ”¹è¿›æ£€ç´¢ç»“æœç»„ç»‡

**é¢„æœŸæ•ˆæœ**ï¼š
- å›å¤è´¨é‡æå‡ 80%+
- "è°å»æ²ˆé˜³æ—…æ¸¸è¿‡"è¿™ç±»é—®é¢˜èƒ½æ­£ç¡®å›ç­”
- èƒ½ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡å’Œçœç•¥è¡¨è¾¾
- ä¸ä¼šå†é¢‘ç¹è¯´"æˆ‘ä¸è®°å¾—"

**ç°åœ¨è¯·æµ‹è¯•ï¼** ğŸš€
