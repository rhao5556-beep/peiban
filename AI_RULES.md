# AI 编程助手规则（Kiro/Trae 专用）

## 🧯 命令安全规范（强制）

- 禁止在 PowerShell 里直接粘贴多行 Python 代码（会被当成 shell 语句执行）。
- 禁止使用高风险 `python -c`：
  - 多行语句、包含 JSON/字典/大括号、包含嵌套引号、需要复杂转义的命令，一律改为写入 `.py` 文件再运行。
- 运行 LoCoMo/KnowMeBench 前必须先做环境预检：
  - 优先执行 `python evals/check_eval_env.py`
  - 或使用已内置预检的入口脚本（可用 `--skip_env_check` 显式跳过）

## 📋 修改前必做（BEFORE）

### 1. 说明改动计划

- 列出将要修改的文件路径
- 用 1-2 句话说明修改目的和预期效果
- **触发条件**：需要修改 ≥3 个文件时，必须先等待我确认

### 2. 检查保护区域

以下文件**禁止直接修改**（除非我明确说可以改）：

```
config/*.json          # 配置文件
src/core/auth.*        # 认证模块
src/db/*              # 数据库相关
.env*                 # 环境变量
[根据你的项目补充其他关键文件]
```

---

## ⚙️ 修改中必做（DURING）

### 3. 遵守单一职责原则

- ✅ 一次只解决一个明确的问题
- ❌ 不要"顺便优化"其他代码
- ❌ 不要同时修复多个不相关的 bug
- ⏸️ 改完一个、验证通过后，再继续下一个

### 4. 保留已有功能

- 不删除已有的测试代码
- 不修改正常工作的其他功能
- 如果必须改动核心逻辑，先告知我

---

## ✅ 修改后必做（AFTER）

### 5. 提供验证步骤

修改完成后必须说明：

- 改了什么（简短描述）
- 如何验证功能是否正常（命令或操作步骤）
- 可能的副作用或需要注意的地方

示例：

```
修改内容：修复了购物车计算总价时未考虑折扣的问题
验证方法：
1. 运行 npm test
2. 或手动测试：添加商品 → 应用优惠券 → 检查总价
注意事项：清空浏览器缓存后再测试
```

### 6. 提供 Git 提交信息

格式：`类型: 简短描述`

类型选择：

- `Fix:` 修复 bug
- `Add:` 新增功能
- `Update:` 更新现有功能
- `Refactor:` 重构代码

示例：

```bash
git commit -m "Fix: 购物车总价计算未包含折扣"
git commit -m "Add: 用户头像上传功能"
```

---

## 🚨 特殊情况处理

### 7. 遇到反复出现的 Bug

如果同一个 bug 修了又出现（或修好 A 又坏 B），**立即停止继续修改**：

**必须执行的步骤：**

1. **分析根本原因**：为什么会反复出现？是否只改了表面症状？
2. **检查相关依赖**：这个修改影响了哪些其他模块？
3. **提供彻底方案**：不要再打补丁，给出根治方案
4. **建议我介入**：如果问题复杂，建议我手动检查核心逻辑

**暂停修改的信号：**

- 同一问题出现 ≥2 次
- 修改 A → 出现 B → 修改 B → A 又坏了
- 连续 3 次修改都没有解决问题

### 8. 记录重要修改（可选）

对于**重大修改或复杂逻辑**，在文件顶部添加简短注释：

```javascript
// AI修改 2024-01-20: 重构支付流程以支持多币种
// 原因：原有逻辑无法处理汇率转换
```

或在 commit message 中补充：

```bash
git commit -m "Refactor: 支付流程重构
- 支持多币种结算
- AI generated: 添加汇率转换中间层"
```

**简单修改不用记录，避免过度标注。**

---

## 💡 使用建议

### 每次对话开始时

```
【规则提醒】修改前请：
1. 说明要改哪些文件
2. 一次只改一个问题
3. 不要动 config/ 和 auth.js
现在请帮我 [具体任务]...
```

### 长对话时（超过10轮）

```
请重新阅读项目根目录的 AI 编程规则，
确保遵守所有约束，特别是：
- 不修改保护区域的文件
- 一次只改一个问题
```

### Git 工作流配合

```bash
# 每次修改成功后立即提交
git add .
git commit -m "Fix: [AI 提供的 commit 信息]"
# 遇到问题可以快速回滚
git log --oneline  # 查看历史
git reset --hard HEAD~1  # 回退到上一次提交
```

---

## 📝 快速检查清单

修改前问自己：

- [ ] AI 说明了要改哪些文件吗？
- [ ] 没有涉及保护区域的文件吧？
- [ ] 这次只改一个问题吧？

修改后问自己：

- [ ] AI 说明了如何验证吗？
- [ ] 我测试通过了吗？
- [ ] 提交 git commit 了吗？

遇到反复 bug 时：

- [ ] 是不是该让 AI 分析根本原因了？
- [ ] 是不是该我自己检查一下了？

---

## 🎯 核心原则总结

1. **透明化**：修改前说明计划
2. **保护性**：核心文件不乱动
3. **专注性**：一次只改一个问题
4. **可验证**：提供测试方法
5. **可追溯**：Git 记录清晰
6. **防反复**：遇到循环立即停止分析

**记住：规则是工具，不是枷锁。根据实际情况灵活调整！**

---

## 📁 保存建议

### 方案 1：保存为项目文件

在项目根目录创建 `AI_RULES.md`，每次开始时提醒 AI：

```
请先阅读 AI_RULES.md 中的规则，然后开始工作
```

### 方案 2：保存为 Kiro/Trae 配置

如果工具支持，创建 `.cursorrules` 或类似配置文件：

```
# 把上面的规则精简版放进去
```

### 方案 3：准备快捷模板

把常用提醒保存为文本片段，需要时快速粘贴：

```
模板1 - 开始工作：
【规则提醒】请遵守 AI_RULES.md，特别注意：
1. 修改前说明文件和目的
2. 不要动 config/ 和 auth.*
3. 一次只改一个问题
现在帮我：[具体任务]

---

模板2 - 反复bug：
这个问题已经第 X 次了！请：
1. 分析根本原因（不是表面）
2. 给出彻底解决方案
3. 说明为什么之前的修复失败

---

模板3 - 长对话提醒：
重新确认 AI_RULES.md 规则，
确保不修改保护区域、一次只改一个问题
```
